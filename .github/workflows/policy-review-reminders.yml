# Automated Policy Review Reminders
# Creates GitHub Issues for policies approaching review dates
# Runs: 1st of each month at 8 AM UTC

name: Policy Review Reminders

on:
  schedule:
    - cron: '0 8 1 * *'  # 1st of each month at 8 AM UTC
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  check-policy-reviews:
    name: Check Policy Review Dates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Identify Policies Needing Review
        id: identify
        run: |
          today=$(date +%s)
          review_threshold_180=$((today - 180 * 86400))  # 6 months ago
          review_threshold_330=$((today - 330 * 86400))  # 11 months ago (1 month warning)
          review_threshold_365=$((today - 365 * 86400))  # 1 year ago

          echo "policies_due_soon=" >> $GITHUB_OUTPUT
          echo "policies_overdue=" >> $GITHUB_OUTPUT

          due_soon=""
          overdue=""

          for policy in security/policies/*.md compliance/gdpr/*.md security/procedures/*.md; do
            if [ -f "$policy" ]; then
              last_modified=$(git log -1 --format="%ct" -- "$policy" 2>/dev/null || echo "$today")

              if [ $last_modified -lt $review_threshold_365 ]; then
                # Overdue - more than 1 year old
                age_days=$(( (today - last_modified) / 86400 ))
                overdue="$overdue|$(basename $policy):$age_days"
              elif [ $last_modified -lt $review_threshold_330 ]; then
                # Due soon - between 11-12 months old
                age_days=$(( (today - last_modified) / 86400 ))
                due_soon="$due_soon|$(basename $policy):$age_days"
              fi
            fi
          done

          echo "policies_due_soon=$due_soon" >> $GITHUB_OUTPUT
          echo "policies_overdue=$overdue" >> $GITHUB_OUTPUT

      - name: Create Issues for Overdue Policies
        if: steps.identify.outputs.policies_overdue != ''
        uses: actions/github-script@v7
        with:
          script: |
            const overdue = '${{ steps.identify.outputs.policies_overdue }}'.split('|').filter(x => x);
            const month = new Date().toLocaleString('default', { month: 'long' });
            const year = new Date().getFullYear();

            for (const entry of overdue) {
              const [policy, ageDays] = entry.split(':');
              if (!policy) continue;

              // Check if issue already exists
              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'policy-review',
                state: 'open'
              });

              const alreadyExists = existingIssues.data.some(
                issue => issue.title.includes(policy)
              );

              if (!alreadyExists) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `OVERDUE: Policy Review Required - ${policy}`,
                  body: `## Policy Review Required

            **Policy:** \`${policy}\`
            **Age:** ${ageDays} days since last update
            **Status:** OVERDUE (>365 days)
            **Month:** ${month} ${year}

            ### Required Actions

            1. [ ] Review policy content for accuracy
            2. [ ] Update any outdated references
            3. [ ] Verify alignment with current practices
            4. [ ] Update version number and date
            5. [ ] Get approval from policy owner
            6. [ ] Commit updated policy

            ### Compliance Impact

            - **SOC 2:** CC1.4 (Policy review requirement)
            - **GDPR:** Article 24 (Accountability)
            - **ISO 27001:** A.5.1 (Policies for information security)

            ---
            *This issue was created automatically by the policy review automation.*
            `,
                  labels: ['policy-review', 'compliance', 'overdue', 'priority-high']
                });
              }
            }

      - name: Create Issues for Policies Due Soon
        if: steps.identify.outputs.policies_due_soon != ''
        uses: actions/github-script@v7
        with:
          script: |
            const dueSoon = '${{ steps.identify.outputs.policies_due_soon }}'.split('|').filter(x => x);
            const month = new Date().toLocaleString('default', { month: 'long' });
            const year = new Date().getFullYear();

            for (const entry of dueSoon) {
              const [policy, ageDays] = entry.split(':');
              if (!policy) continue;

              // Check if issue already exists
              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'policy-review',
                state: 'open'
              });

              const alreadyExists = existingIssues.data.some(
                issue => issue.title.includes(policy)
              );

              if (!alreadyExists) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `UPCOMING: Policy Review Due - ${policy}`,
                  body: `## Policy Review Upcoming

            **Policy:** \`${policy}\`
            **Age:** ${ageDays} days since last update
            **Status:** Due within 30 days
            **Month:** ${month} ${year}

            ### Required Actions

            1. [ ] Schedule policy review meeting
            2. [ ] Review policy content for accuracy
            3. [ ] Update any outdated references
            4. [ ] Complete review before ${365 - ageDays} days

            ---
            *This issue was created automatically by the policy review automation.*
            `,
                  labels: ['policy-review', 'compliance', 'upcoming']
                });
              }
            }

  quarterly-reminders:
    name: Quarterly Task Reminders
    runs-on: ubuntu-latest
    # Only run on 1st of Jan, Apr, Jul, Oct
    if: contains('1,4,7,10', format('{0}', github.event.schedule && '1' || '0'))

    steps:
      - name: Create Quarterly Reminder Issues
        uses: actions/github-script@v7
        with:
          script: |
            const month = new Date().getMonth() + 1;
            const quarter = Math.ceil(month / 3);
            const year = new Date().getFullYear();

            const quarterlyTasks = [
              {
                title: `Q${quarter} ${year}: Access Review Required`,
                body: `## Quarterly Access Review

            **Quarter:** Q${quarter} ${year}
            **Due:** End of quarter

            ### Required Actions

            1. [ ] Review all user access permissions
            2. [ ] Remove terminated employee access
            3. [ ] Verify least privilege principle
            4. [ ] Document access review results
            5. [ ] Update access control matrix

            ### Systems to Review
            - GitHub repository access
            - Railway deployment access
            - Supabase database access
            - n8n workflow access
            - Cloud provider consoles

            ---
            *SOC 2 CC6.1, CC6.2, CC6.3 compliance requirement*
            `,
                labels: ['quarterly-task', 'access-review', 'compliance', 'soc2']
              },
              {
                title: `Q${quarter} ${year}: Vulnerability Scan Required`,
                body: `## Quarterly Vulnerability Assessment

            **Quarter:** Q${quarter} ${year}
            **Due:** End of quarter

            ### Required Actions

            1. [ ] Run automated dependency scan
            2. [ ] Review npm audit results
            3. [ ] Check for container vulnerabilities
            4. [ ] Document findings and remediation
            5. [ ] Update vulnerability register

            ### Scan Tools
            - GitHub Dependabot alerts
            - npm audit
            - Snyk (if configured)
            - Trivy container scan

            ---
            *SOC 2 CC7.1 compliance requirement*
            `,
                labels: ['quarterly-task', 'vulnerability-scan', 'compliance', 'soc2']
              },
              {
                title: `Q${quarter} ${year}: Backup Restoration Test Required`,
                body: `## Quarterly Backup Test

            **Quarter:** Q${quarter} ${year}
            **Due:** End of quarter

            ### Required Actions

            1. [ ] Identify test backup to restore
            2. [ ] Perform restoration to test environment
            3. [ ] Verify data integrity
            4. [ ] Document restoration time (RTO)
            5. [ ] Update DR runbook if needed

            ### Systems to Test
            - Supabase database backup
            - Railway PostgreSQL backup
            - n8n workflow exports

            ---
            *SOC 2 A1.2 compliance requirement*
            `,
                labels: ['quarterly-task', 'backup-test', 'compliance', 'soc2']
              }
            ];

            for (const task of quarterlyTasks) {
              // Check if issue already exists this quarter
              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'quarterly-task',
                state: 'open'
              });

              const alreadyExists = existingIssues.data.some(
                issue => issue.title.includes(`Q${quarter} ${year}`) && issue.title.includes(task.title.split(':')[1].trim())
              );

              if (!alreadyExists) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: task.title,
                  body: task.body,
                  labels: task.labels
                });
              }
            }
