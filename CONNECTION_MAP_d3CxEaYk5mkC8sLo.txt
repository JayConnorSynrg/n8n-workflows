TEAMS VOICE BOT v3.0 - COMPLETE CONNECTION MAP
Workflow ID: d3CxEaYk5mkC8sLo
Date: 2026-01-10

================================================================================
ENTRY POINT
================================================================================
Webhook (POST /voice-bot-v3) [v2.1]
  └─> Process Transcript [code v2]


================================================================================
PRIMARY PROCESSING PIPELINE
================================================================================

Process Transcript [code v2]
  └─> Ultra-Fast Pre-Router [code v2]

Ultra-Fast Pre-Router [code v2] [ROUTING DECISION POINT]
  ├─> Pre-Route Switch [switch v3]
  │    ├─ SILENT Route
  │    ├─ BUFFER Route  
  │    ├─ WAIT_LOG Route
  │    └─ FULL_PROCESS Route
  └─> Intent Summary Merger [code] (For FULL_PROCESS)


PRE-ROUTE SWITCH: SILENT ROUTE
Pre-Route Switch (SILENT)
  └─> Log Silent Transcript [postgres v2.6]

PRE-ROUTE SWITCH: BUFFER/WAIT_LOG ROUTE
Pre-Route Switch (BUFFER/WAIT_LOG)
  └─> Wait Log Only [code v2]
      └─> Log Wait Transcript [postgres v2.6]

PRE-ROUTE SWITCH: FULL_PROCESS ROUTE
Pre-Route Switch (FULL_PROCESS)
  └─> Intent Summary Merger [code v6503 chars]
      ├─ References: Fast Intent Query results (historical)
      └─> Load Bot State [postgres v2.6]
          └─> Build Agent Context [code v3278 chars]
              ├─ References: Pre-Route Switch data (for transcript/bot_id)
              └─> Orchestrator Agent [langchain.agent v3]
                  ├─ Connected to: OpenRouter Chat Model [langchain.lmChatOpenRouter v1]
                  ├─ Tool: Gmail Agent Tool [langchain.toolWorkflow v2.2]
                  ├─ Tool: Think Tool [langchain.toolThink v1.1]
                  └─> Check Agent Output [if v2.3]
                      └─> Split into Sentences [code v2644 chars]
                          ├─ References: Build Agent Context (bot_id)
                          ├─ References: Pre-Route Switch (fallback bot_id)
                          └─> Parallel TTS & Send [code v4151 chars]
                              ├─ External API: OpenAI TTS
                              ├─ External API: Recall.ai
                              └─> Build Immutable Log [code v3630 chars]
                                  ├─ References: Orchestrator Agent
                                  ├─ References: Build Agent Context
                                  └─ (Final logging/recording)


PARALLEL BRANCH: INTERRUPT HANDLING
Interrupt Handler [code v2196 chars]
  └─> Log Interrupt [postgres v2.6]


SUPPORTING QUERIES
Fast Intent Query [postgres v2.6]
  <- Called by: Intent Summary Merger (for historical context)


================================================================================
NODE EXECUTION ORDER (MAIN FULL_PROCESS PATH)
================================================================================
1. Webhook                      [Entry point, receives POST]
2. Process Transcript           [Parse webhook data]
3. Ultra-Fast Pre-Router        [Classify route decision]
4. Pre-Route Switch             [Branch based on classification]
5. Fast Intent Query            [Async: Fetch historical data]
6. Intent Summary Merger        [Weighted routing decision]
7. Load Bot State              [Fetch bot context from DB]
8. Build Agent Context         [Prepare agent prompt]
9. Orchestrator Agent          [LLM reasoning with tools]
10. OpenRouter Chat Model      [Model inference]
11. Gmail Agent Tool           [Tool: email operations]
12. Think Tool                 [Tool: reasoning]
13. Check Agent Output         [IF validation]
14. Split into Sentences       [TTS chunking]
15. Parallel TTS & Send        [External TTS + delivery]
16. Build Immutable Log        [Record all metadata]
17. Log Interrupt             [Async: interrupt recording if occurs]


================================================================================
SILENT PATH (Execution Order)
================================================================================
1. Webhook
2. Process Transcript
3. Ultra-Fast Pre-Router
4. Pre-Route Switch
5. Log Silent Transcript
[END - No agent processing]


================================================================================
BUFFER/WAIT_LOG PATH (Execution Order)
================================================================================
1. Webhook
2. Process Transcript
3. Ultra-Fast Pre-Router
4. Pre-Route Switch
5. Wait Log Only
6. Log Wait Transcript
[END - No agent processing]


================================================================================
DATA FLOW BY NODE TYPE
================================================================================

ENTRY/WEBHOOK NODES (1)
  - Webhook [2.1] → Starts the workflow

CODE PROCESSING NODES (9)
  1. Process Transcript [2] - Payload parsing
  2. Ultra-Fast Pre-Router [2] - Heuristic classification
  3. Wait Log Only [2] - Logging formatter
  4. Build Agent Context [2] - Prompt preparation
  5. Build Immutable Log [2] - Logging formatter
  6. Split into Sentences [2] - TTS chunking
  7. Parallel TTS & Send [2] - External API calls
  8. Quick Acknowledge [2] - Fast response
  9. Quick Reply [2] - Template response
  10. Interrupt Handler [2] - Interrupt processing

CONTROL FLOW NODES (2)
  1. Pre-Route Switch [switch v3] - Routes based on classification
  2. Route Switch [switch v3.2] - Secondary routing (role TBD)
  3. Check Agent Output [if v2.3] - Validates response

DATABASE NODES (5)
  1. Load Bot State [postgres v2.6] - State retrieval
  2. Log Silent Transcript [postgres v2.6] - Audit log
  3. Log Wait Transcript [postgres v2.6] - Audit log
  4. Fast Intent Query [postgres v2.6] - Context lookup
  5. Log Interrupt [postgres v2.6] - Analytics

AI/LANGCHAIN NODES (4)
  1. Orchestrator Agent [langchain.agent v3] - Main AI engine
  2. OpenRouter Chat Model [langchain.lmChatOpenRouter v1] - LLM provider
  3. Gmail Agent Tool [langchain.toolWorkflow v2.2] - Tool: Gmail
  4. Think Tool [langchain.toolThink v1.1] - Tool: Reasoning

OTHER NODES (1)
  1. Call Logging Agent [executeWorkflow v1.2] - Workflow executor


================================================================================
CRITICAL NODE REFERENCES (Cross-Node Dependencies)
================================================================================

Build Immutable Log references:
  - Orchestrator Agent (output)
  - Build Agent Context (metadata)
  - Parallel TTS & Send (TTS info)

Build Agent Context references:
  - Pre-Route Switch (transcript/bot_id source)
  
Split into Sentences references:
  - Build Agent Context (bot_id primary)
  - Pre-Route Switch (bot_id fallback)

Interrupt Handler references:
  - None (standalone processing)


================================================================================
CONNECTION COUNT BREAKDOWN
================================================================================
Total Connections: 21

Main Flow Connections: 16
  Webhook → Process Transcript
  Process Transcript → Ultra-Fast Pre-Router
  Ultra-Fast Pre-Router → Pre-Route Switch
  Pre-Route Switch → SILENT path (Log Silent)
  Pre-Route Switch → BUFFER path (Wait Log → Log Wait)
  Pre-Route Switch → FULL_PROCESS path (Intent Merger)
  Intent Merger → Load Bot State
  Load Bot State → Build Agent Context
  Build Agent Context → Orchestrator Agent
  Orchestrator Agent → Check Output
  Check Output → Split Sentences
  Split Sentences → Parallel TTS
  Parallel TTS → Build Log
  (Plus support connections for agent tools)

Database/Async Connections: 5
  Intent Merger → Fast Intent Query
  Orchestrator Agent → Log Interrupt
  (Other logging branches)


================================================================================
WEBHOOK ENDPOINT DETAILS
================================================================================
Endpoint: POST /voice-bot-v3
Webhook ID: voice-bot-v3
typeVersion: 2.1
HTTP Method: POST

Expected Input:
{
  "body": {
    "data": {
      "data": {
        "words": [
          {"text": "...", "startTime": 0, "endTime": 100}
        ],
        "participant": {"name": "user_name"}
      }
    }
  }
}


================================================================================
TYPEVERSION CONSISTENCY
================================================================================
All nodes using current/recent typeVersions:
✓ n8n-nodes-base.webhook: 2.1
✓ n8n-nodes-base.code: 2
✓ n8n-nodes-base.switch: 3, 3.2 (minor variation)
✓ n8n-nodes-base.postgres: 2.6
✓ n8n-nodes-base.if: 2.3
✓ n8n-nodes-base.executeWorkflow: 1.2
✓ @n8n/n8n-nodes-langchain.agent: 3
✓ @n8n/n8n-nodes-langchain.lmChatOpenRouter: 1
✓ @n8n/n8n-nodes-langchain.toolWorkflow: 2.2
✓ @n8n/n8n-nodes-langchain.toolThink: 1.1

Note: Switch node has dual versions (3 and 3.2), verify consistency.


================================================================================
ROUTING DECISION LOGIC
================================================================================

Pre-Route Switch Classification:
┌─ SILENT
│  └─ Condition: Silence detected
│     Action: Log only, exit
│
├─ BUFFER  
│  └─ Condition: Partial data detected
│     Action: Log, wait for more input
│
├─ WAIT_LOG
│  └─ Condition: Buffered content
│     Action: Log and skip agent
│
└─ FULL_PROCESS
   └─ Condition: Complete utterance detected
      Action: Route to agent for processing


Intent Summary Merger Weighting:
  History Signals: 40%
  Intent Signals: 40%
  Interrupt Signals: 20%
  Total: 100% (normalized scoring)


================================================================================
CREDENTIALS & EXTERNAL DEPENDENCIES
================================================================================

Required Credentials:
  1. openRouterApi - For OpenRouter LLM calls
  2. postgres - For all database operations

External APIs Called:
  1. OpenAI TTS API (from Parallel TTS & Send code)
  2. Recall.ai (from Parallel TTS & Send code)
  3. OpenRouter API (from Orchestrator Agent → OpenRouter Chat Model)

Note: OpenAI API key embedded in "Parallel TTS & Send" - SECURITY CONCERN


================================================================================
WORKFLOW EXECUTION PROFILE
================================================================================

Execution Order: v1
Caller Policy: workflowsFromSameOwner
Available in MCP: False

Performance Targets:
  - Pre-Router Classification: <10ms (heuristic-based)
  - Agent Max Iterations: 5 (prevents runaway loops)
  - TTS Chunking: Sentence-level
  - Silent/Buffer Exit: <50ms (minimal processing)


================================================================================
NOTES FOR RESTRUCTURING
================================================================================

1. Webhook Entry Point
   - Currently expects discrete POST requests with complete transcripts
   - For OpenAI Realtime: Replace with WebSocket listener

2. Process Transcript Node
   - Currently uses runOnceForEachItem mode
   - For Realtime: Convert to streaming processor

3. Ultra-Fast Pre-Router
   - Currently expects complete transcript for classification
   - For Realtime: Implement partial transcript handling

4. TTS Pipeline
   - Currently sequential (wait for complete response)
   - For Realtime: Implement streaming/bi-directional audio

5. Agent Configuration
   - Currently 5 max iterations
   - For Realtime: Consider reducing to 2-3 for latency

6. Tool Integration
   - Gmail and Think tools present
   - For Realtime: Verify tool output streaming compatibility

7. Interruption Handling
   - Currently post-processing analysis
   - For Realtime: Implement real-time cancellation

================================================================================
End of Connection Map
================================================================================
